<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>V-Med ID | Create Password</title>
  <link rel="stylesheet" href="../login/login.css" />
</head>
<body>

  <div class="login-container">

    <img src="../../assets/images/logo.jpg" alt="V-Med ID Logo" class="logo" />

    <h2>Create Password</h2>
    <p class="subtitle">
      Set a secure password for your V-Med ID
    </p>

    <form id="passwordForm">

      <label>Create Password <span style="color:red">*</span></label>
      <input
        type="password"
        id="password"
        placeholder="Enter strong password"
        required
      />

      <label>Confirm Password <span style="color:red">*</span></label>
      <input
        type="password"
        id="confirmPassword"
        placeholder="Re-enter password"
        required
      />

      <p id="error" style="color:#d32f2f; font-size:13px;"></p>

      <button type="submit">Finish Registration</button>

    </form>

  </div>

 <script type="module">
  import { signupUser } from "../../js/auth.js";
  import {
    savePatientApplication,
    saveDoctorApplication
  } from "../../js/app.js";

  document.getElementById("passwordForm").addEventListener("submit", async function (e) {
    e.preventDefault();

    const password = document.getElementById("password").value;
    const confirm = document.getElementById("confirmPassword").value;
    const error = document.getElementById("error");

    if (password.length < 6) {
      error.textContent = "Password must be at least 6 characters.";
      return;
    }

    if (password !== confirm) {
      error.textContent = "Passwords do not match.";
      return;
    }

    // Get stored signup data
    const role = sessionStorage.getItem("signupRole");
    const email = sessionStorage.getItem("email");

    if (!email) {
      error.textContent = "Email is required to create account.";
      return;
    }

    try {
      // 1️⃣ Create Firebase Auth user
      const user = await signupUser(email, password);

      // 2️⃣ Save application data
      const rawData = JSON.parse(sessionStorage.getItem("applicationData"));

      if (role === "patient") {
        await savePatientApplication(user, rawData);
      }

      if (role === "doctor") {
        await saveDoctorApplication(user, rawData);
      }

      // Cleanup temp data
      sessionStorage.clear();

      window.location.href = "signup_success.html";


    } catch (err) {
      error.textContent = err.message;
    }
  });
</script>

</body>
</html>
